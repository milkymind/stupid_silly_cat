let stage;
let layer;
let backgroundImage;
let templates = [];

document.getElementById('image-upload').addEventListener('change', handleImageUpload);

function handleImageUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvasContainer = document.getElementById('canvas-container');
            canvasContainer.innerHTML = ''; // Clear existing canvas
            const width = 400;
            const height = 400;

            stage = new Konva.Stage({
                container: 'canvas-container',
                width: width,
                height: height
            });

            layer = new Konva.Layer();
            stage.add(layer);

            backgroundImage = new Konva.Image({
                image: img,
                width: width,
                height: height
            });

            layer.add(backgroundImage);
            layer.draw();

            // Show download button
            document.getElementById('download-btn').classList.remove('hidden');
        }
        img.src = e.target.result;
    }
    
    reader.readAsDataURL(file);
}

document.querySelectorAll('.template-item img').forEach(item => {
    item.addEventListener('dragstart', function (e) {
        e.dataTransfer.setData('templateSrc', e.target.src);
    });
});

document.getElementById('canvas-container').addEventListener('dragover', function (e) {
    e.preventDefault();
});

document.getElementById('canvas-container').addEventListener('drop', function (e) {
    e.preventDefault();
    const templateSrc = e.dataTransfer.getData('templateSrc');
    const offsetX = e.offsetX;
    const offsetY = e.offsetY;
    addTemplate(templateSrc, offsetX, offsetY);
});

function addTemplate(templateSrc, x, y) {
    const templateImg = new Image();
    templateImg.onload = function () {
        const template = new Konva.Image({
            x: x,
            y: y,
            image: templateImg,
            draggable: true
        });

        template.on('transform', function () {
            template.setAttrs({
                width: template.width() * template.scaleX(),
                height: template.height() * template.scaleY(),
                scaleX: 1,
                scaleY: 1
            });
        });

        layer.add(template);
        templates.push(template);
        layer.draw();
    };
    templateImg.src = templateSrc;
}

document.getElementById('download-btn').addEventListener('click', function () {
    const dataURL = stage.toDataURL({ pixelRatio: 1 });
    const link = document.createElement('a');
    link.href = dataURL;
    link.download = 'customized-image.jpeg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
