document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let uploadedImage;

    // Handle image upload
    document.getElementById('image-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = 400;
                    canvas.height = 400;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    uploadedImage = img;
                    showDownloadButton();
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Enable templates to be draggable
    const templateItems = document.querySelectorAll('.template-item img');
    templateItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', item.src);
        });
    });

    // Prevent default behavior for drag events
    canvas.addEventListener('dragover', function(e) {
        e.preventDefault();
    });

    // Handle drop event on canvas
    canvas.addEventListener('drop', function(e) {
        e.preventDefault();
        const templateSrc = e.dataTransfer.getData('text/plain');
        const offsetX = e.offsetX - 25; // Adjust for template size
        const offsetY = e.offsetY - 25; // Adjust for template size

        const templateImg = new Image();
        templateImg.onload = function() {
            ctx.drawImage(templateImg, offsetX, offsetY, 50, 50); // Draw template on canvas
        };
        templateImg.src = templateSrc;
    });

    // Show download button when image is uploaded and templates are added
    function showDownloadButton() {
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.style.display = 'block';
    }

    // Handle download button click
    document.getElementById('download-btn').addEventListener('click', function() {
        const dataURL = canvas.toDataURL('image/jpeg');
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = 'silly-image.jpeg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
