document.getElementById('image-upload').addEventListener('change', handleImageUpload);

function handleImageUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // Resize and center the image on the canvas
            const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
            const x = (canvas.width / 2) - (img.width / 2) * scale;
            const y = (canvas.height / 2) - (img.height / 2) * scale;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

            document.getElementById('canvas').classList.remove('hidden');
        }
        img.src = e.target.result;
    }
    
    reader.readAsDataURL(file);
}

function applyOverlay() {
    const templateSelect = document.getElementById('template-select');
    const templateSrc = templateSelect.value;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resizeFactor = document.getElementById('resize-range').value / 100;
    const rotationDegrees = document.getElementById('rotate-range').value;
    const templateImg = new Image();

    templateImg.onload = function() {
        const width = templateImg.width * resizeFactor;
        const height = templateImg.height * resizeFactor;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height); 
        
        // Redraw the base image
        const baseImg = new Image();
        baseImg.onload = function() {
            const scale = Math.min(canvas.width / baseImg.width, canvas.height / baseImg.height);
            const x = (canvas.width / 2) - (baseImg.width / 2) * scale;
            const y = (canvas.height / 2) - (baseImg.height / 2) * scale;
            ctx.drawImage(baseImg, x, y, baseImg.width * scale, baseImg.height * scale);

            // Apply rotation and overlay template image
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate((rotationDegrees * Math.PI) / 180);
            ctx.drawImage(templateImg, -width / 2, -height / 2, width, height);
            ctx.restore();
    
            document.getElementById('download-link').href = canvas.toDataURL('image/jpeg');
            document.getElementById('download-link').classList.remove('hidden');
        }
        baseImg.src = document.getElementById('image-upload').files[0].result;
    }

    templateImg.src = templateSrc;
}
